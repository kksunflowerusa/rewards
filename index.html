<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æœƒå“¡å„²å€¼èˆ‡äº¤æ˜“æŸ¥è©¢</title>
  <style>
    body { font-family:"Noto Sans TC",Arial,sans-serif; max-width:860px; margin:30px auto; padding:0 12px; background:#f8fafc; }
    h2 { text-align:center; color:#222; margin-bottom:6px; }
    label { display:block; margin-top:10px; font-weight:bold; }
    input, select { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:15px; box-sizing:border-box; }
    button { width:100%; margin-top:10px; padding:10px; background:#007bff; color:white; border:none; border-radius:6px; font-size:15px; cursor:pointer; }
    button:hover { background:#005fcc; }
    .result { margin-top:20px; }
    .error { color:#d32f2f; text-align:center; font-weight:bold; }
    .balance, .summary { text-align:center; font-size:16px; font-weight:bold; color:#007bff; margin-top:10px; }
    .muted { text-align:center; color:#666; font-size:13px; margin-top:6px; }
    table { width:100%; border-collapse:collapse; margin-top:15px; background:white; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; font-size:13px; }
    th { background:#f1f3f5; }
    @media (max-width:720px) { th, td { font-size:12px; padding:6px; } }
  </style>
</head>
<body>
  <h2>Aæœƒå“¡å„²å€¼èˆ‡äº¤æ˜“æŸ¥è©¢</h2>

  <label>æœƒå“¡è™Ÿ (ä¾‹å¦‚ï¼šA12345)</label>
  <input id="memberID" placeholder="è«‹è¼¸å…¥æœƒå“¡è™Ÿ">

  <label>é–‹å§‹æ—¥æœŸ</label>
  <input id="startDate" type="date">

  <label>çµæŸæ—¥æœŸ</label>
  <input id="endDate" type="date">

  <label>å¿«æ·æŸ¥è©¢</label>
  <select id="quickRange" onchange="applyQuickRange()">
    <option value="">--è«‹é¸æ“‡--</option>
    <option value="30">è¿‘30å¤©</option>
    <option value="60">è¿‘60å¤©</option>
  </select>

  <button onclick="search()">æŸ¥è©¢</button>
  <div id="result" class="result"></div>

  <script>
    // è«‹æ”¹æˆä½ å¯¦éš›éƒ¨ç½²å¾Œçš„ Apps Script ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbx63M2C-5VqkZXvsjjH1IqltEFFA5jf9xM6_qNC8w3Yy6chr8j9uqBgYOwZ2eY0JcI/exec";

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, s => (
        { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[s]
      ));
    }

    function applyQuickRange() {
      const range = document.getElementById("quickRange").value;
      if (!range) {
        document.getElementById("startDate").value = "";
        document.getElementById("endDate").value = "";
        return;
      }
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - Number(range));
      document.getElementById("startDate").value = start.toISOString().slice(0,10);
      document.getElementById("endDate").value = end.toISOString().slice(0,10);
    }

    async function search() {
      const memberID = document.getElementById('memberID').value.trim();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = "æŸ¥è©¢ä¸­...";

      if (!memberID) {
        resultDiv.innerHTML = `<p class="error">è«‹è¼¸å…¥æœƒå“¡è™Ÿã€‚</p>`;
        return;
      }

      try {
        const url = `${API_URL}?memberID=${encodeURIComponent(memberID)}&startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`;
        const resp = await fetch(url);
        const data = await resp.json();

        console.log("API å›å‚³ï¼š", data);  // ğŸ” ç”¨æ–¼èª¿è©¦ï¼ŒæŸ¥çœ‹å®Œæ•´å›å‚³è³‡æ–™

        if (data.error) {
          resultDiv.innerHTML = `<p class="error">${escapeHtml(data.error)}</p>`;
          return;
        }

        const rows = data.transactions || [];
        const currentBalance = data.currentBalance || "0";
        const totalDeposit = data.totalDeposit || "0";
        const totalBonus = data.totalBonus || "0";
        const totalDiscountAmount = data.totalDiscountAmount || "0";
        const memberLevel = data.memberLevel || "-";
        const memberDiscount = data.memberDiscount || "-";
        const memberExpire = data.memberExpire || "-";
        const note = data.note || "";

        let html = `<div class="balance">ç›®å‰é¤˜é¡ï¼š$${escapeHtml(String(currentBalance))}</div>`;
        html += `<div class="summary">æœƒå“¡ç­‰ç´šï¼š${escapeHtml(memberLevel)}ã€€ï½œã€€æŠ˜æ‰£ï¼š${escapeHtml(memberDiscount)}%ã€€ï½œã€€åˆ°æœŸæ—¥ï¼š${escapeHtml(memberExpire)}</div>`;
        html += `<div class="summary">æ­·å²å„²å€¼ç¸½é¡ï¼š$${escapeHtml(String(totalDeposit))}ã€€ï½œã€€æ­·å²ç´…åˆ©ç¸½é¡ï¼š$${escapeHtml(String(totalBonus))}ã€€ï½œã€€æ­·å²æŠ˜æ‰£ç¸½é¡ï¼š$${escapeHtml(String(totalDiscountAmount))}</div>`;

        if (note) {
          html += `<div class="muted">${escapeHtml(note)}</div>`;
        }

        html += `<p style="text-align:center; margin-top:6px;">å…± ${rows.length} ç­†äº¤æ˜“ç´€éŒ„</p>`;

        if (rows.length === 0) {
          html += `<div style="text-align:center; margin-top:10px; color:#666;">ç„¡ç¬¦åˆç¯©é¸çš„äº¤æ˜“ç´€éŒ„ã€‚</div>`;
          resultDiv.innerHTML = html;
          return;
        }

        html += `<table><tr>
          <th>æ—¥æœŸ</th>
          <th>è¨‚å–®è™Ÿ</th>
          <th>å„²å€¼é‡‘</th>
          <th>ç´…åˆ©</th>
          <th>æ‰£æ¬¾é‡‘é¡</th>
          <th>æŠ˜æ‰£é‡‘é¡</th>
          <th>ç‰¹æ®Šèª¿æ•´</th>
          <th>é¤˜é¡</th>
        </tr>`;

        html += rows.map(r => `
          <tr>
            <td>${escapeHtml(r.date)}</td>
            <td>${escapeHtml(r.orderID)}</td>
            <td>${escapeHtml(String(r.deposit))}</td>
            <td>${escapeHtml(String(r.bonus))}</td>
            <td>${escapeHtml(String(r.deduction))}</td>
            <td>${escapeHtml(String(r.discountAmount))}</td>
            <td>${escapeHtml(String(r.adjustment))}</td>
            <td>${escapeHtml(String(r.balance))}</td>
          </tr>
        `).join('');

        html += `</table>`;
        resultDiv.innerHTML = html;

      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `<p class="error">æŸ¥è©¢å¤±æ•—ï¼š${escapeHtml(err.message)}</p>`;
      }
    }
  </script>
</body>
</html>
