<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>會員交易查詢</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; max-width: 1100px; }
    h1 { font-size: 20px; margin-bottom: 6px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px; }
    .controls input[type="text"], .controls input[type="date"] { padding:8px; border:1px solid #ccc; border-radius:4px; }
    button { padding:8px 12px; border-radius:6px; border:1px solid #2d89ef; background:#2d89ef; color:white; cursor:pointer; }
    button.secondary { background:transparent; color:#2d89ef; border:1px solid #2d89ef; }
    button.small { padding:6px 8px; font-size:13px; }
    .summary { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .card { padding:10px; border-radius:8px; box-shadow: 0 0 0 1px #eee inset; min-width:150px; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { border:1px solid #eee; padding:8px; text-align:left; font-size:14px; }
    th { background:#fafafa; }
    .muted { color:#666; font-size:13px; }
    .right { text-align:right; }
    @media (max-width:700px) {
      .controls { flex-direction:column; align-items:stretch; }
      .summary { flex-direction:column; }
    }
  </style>
</head>
<body>
  <h1>會員交易查詢</h1>
  <div class="controls">
    <div>
      <label>會員帳號 (Member ID)</label><br>
      <input id="memberId" type="text" placeholder="輸入會員帳號">
    </div>

    <div>
      <label>開始日期</label><br>
      <input id="startDate" type="date">
    </div>

    <div>
      <label>結束日期</label><br>
      <input id="endDate" type="date">
    </div>

    <div style="display:flex; flex-direction:column; gap:6px;">
      <label>&nbsp;</label>
      <div>
        <button id="btnSearch">查詢</button>
        <button class="secondary small" id="btn30">近 30 天</button>
        <button class="secondary small" id="btn60">近 60 天</button>
        <button class="secondary small" id="btnClear">清除</button>
      </div>
    </div>
  </div>

  <div id="message" class="muted"></div>

  <div class="summary" id="summaryArea" style="display:none;">
    <div class="card">
      <div class="muted">最後總餘額</div>
      <div id="lastBalance" style="font-weight:700; font-size:18px;">0</div>
    </div>
    <div class="card">
      <div class="muted">會員等級</div>
      <div id="membership" style="font-weight:700;">-</div>
      <div class="muted">折扣%</div>
      <div id="membershipDiscount">-</div>
      <div class="muted">到期日</div>
      <div id="membershipExpiration">-</div>
    </div>
    <div class="card">
      <div class="muted">歷史總儲值</div>
      <div id="totalDeposit" style="font-weight:700;">0</div>
      <div class="muted">歷史總紅利</div>
      <div id="totalBonus" style="font-weight:700;">0</div>
    </div>
    <div class="card">
      <div class="muted">歷史訂單金額</div>
      <div id="totalAmount" style="font-weight:700;">0</div>
      <div class="muted">歷史折扣金額</div>
      <div id="totalDiscount" style="font-weight:700;">0</div>
    </div>
  </div>

  <div id="resultArea" style="margin-top:12px;">
    <table id="resultTable" style="display:none;">
      <thead>
        <tr>
          <th>日期</th>
          <th>訂單號碼</th>
          <th class="right">儲值金</th>
          <th class="right">會員紅利</th>
          <th class="right">扣款金額</th>
          <th class="right">折扣金額</th>
          <th class="right">特殊調整</th>
          <th class="right">餘額</th>
        </tr>
      </thead>
      <tbody id="resultBody"></tbody>
    </table>
    <div id="noData" class="muted" style="display:none; margin-top:8px;">沒有資料</div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyFY8g6-NJFPla4ZcTtf0uHHpFlh22M3kNl8mU9mQaD3oXWXJBbEByLb4mIqlfmBs0g/exec';
    const $ = id => document.getElementById(id);

    function showMessage(msg) { $('message').textContent = msg || ''; }
    function formatNumber(n) { if (n === '' || n === null || n === undefined) return ''; return Number(n).toLocaleString(); }
    function clearResults() {
      $('resultBody').innerHTML = '';
      $('resultTable').style.display = 'none';
      $('noData').style.display = 'none';
      $('summaryArea').style.display = 'none';
    }

    function renderSummary(s) {
      $('lastBalance').textContent = formatNumber(s.lastBalance);
      $('membership').textContent = s.membership || '-';
      $('membershipDiscount').textContent = s.membershipDiscount || '-';
      $('membershipExpiration').textContent = s.membershipExpiration || '-';
      $('totalDeposit').textContent = formatNumber(s.totalDeposit);
      $('totalBonus').textContent = formatNumber(s.totalBonus);
      $('totalAmount').textContent = formatNumber(s.totalAmount);
      $('totalDiscount').textContent = formatNumber(s.totalDiscount);
      $('summaryArea').style.display = 'flex';
    }

    function renderRows(rows) {
      const tbody = $('resultBody');
      tbody.innerHTML = '';
      if (!rows || rows.length === 0) {
        $('resultTable').style.display = 'none';
        $('noData').style.display = 'block';
        return;
      }
      $('noData').style.display = 'none';
      $('resultTable').style.display = 'table';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date || ''}</td>
          <td>${escapeHtml(r.orderId || '')}</td>
          <td class="right">${formatNumber(r.deposit)}</td>
          <td class="right">${formatNumber(r.bonus)}</td>
          <td class="right">${formatNumber(r.amount)}</td>
          <td class="right">${formatNumber(r.discount)}</td>
          <td class="right">${formatNumber(r.adjustment)}</td>
          <td class="right">${r.balance === '' ? '' : formatNumber(r.balance)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replaceAll('&', "&amp;")
        .replaceAll('<', "&lt;")
        .replaceAll('>', "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function queryMember(memberId, startDate, endDate) {
      if (!memberId) {
        showMessage('請輸入會員帳號');
        return;
      }
      showMessage('查詢中...');
      clearResults();

      const url = new URL(API_URL);
      url.searchParams.set('memberId', memberId);
      if (startDate) url.searchParams.set('startDate', startDate);
      if (endDate) url.searchParams.set('endDate', endDate);

      try {
        const resp = await fetch(url.toString());
        const data = await resp.json();
        if (!data.success) {
          showMessage(data.message || '查詢失敗');
          return;
        }
        showMessage('');
        renderSummary(data.summary);
        renderRows(data.data);
      } catch (err) {
        showMessage('錯誤: ' + err.message);
      }
    }

    $('btnSearch').addEventListener('click', function() {
      const memberId = $('memberId').value.trim();
      const startDate = $('startDate').value || null;
      const endDate = $('endDate').value || null;
      queryMember(memberId, startDate, endDate);
    });

    $('btn30').addEventListener('click', function() {
      const memberId = $('memberId').value.trim();
      if (!memberId) { showMessage('請先輸入會員帳號再使用快捷查詢'); return; }
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 29);
      $('startDate').value = start.toISOString().slice(0,10);
      $('endDate').value = end.toISOString().slice(0,10);
      queryMember(memberId, $('startDate').value, $('endDate').value);
    });

    $('btn60').addEventListener('click', function() {
      const memberId = $('memberId').value.trim();
      if (!memberId) { showMessage('請先輸入會員帳號再使用快捷查詢'); return; }
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 59);
      $('startDate').value = start.toISOString().slice(0,10);
      $('endDate').value = end.toISOString().slice(0,10);
      queryMember(memberId, $('startDate').value, $('endDate').value);
    });

    $('btnClear').addEventListener('click', function() {
      $('memberId').value = '';
      $('startDate').value = '';
      $('endDate').value = '';
      showMessage('');
      clearResults();
    });

    $('memberId').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { $('btnSearch').click(); }
    });
  </script>
</body>
</html>
