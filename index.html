<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>會員儲值與交易查詢</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 950px; margin: 30px auto; padding: 20px; }
  h2 { color: #333; }
  label { display: inline-block; width: 120px; }
  input { margin: 5px; }
  button { padding: 6px 12px; margin-top: 10px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background-color: #f2f2f2; }
  .summary { background-color: #fafafa; padding: 10px; margin-top: 15px; border: 1px solid #ccc; }
</style>
</head>
<body>
<h2>會員儲值與交易查詢</h2>
<div>
  <label>會員號：</label><input type="text" id="memberID" placeholder="輸入會員號"><br>
  <label>起始日期：</label><input type="date" id="startDate">
  <label>結束日期：</label><input type="date" id="endDate"><br>
  <button onclick="search()">查詢</button>
</div>

<div id="result"></div>

<script>
async function search() {
  const memberID = document.getElementById("memberID").value.trim();
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;

  if (!memberID) {
    alert("請輸入會員號");
    return;
  }

  document.getElementById("result").innerHTML = "查詢中，請稍候...";

  const url = `https://script.google.com/macros/s/AKfycbxofF78YAQsoqeAuVJz8nLguSSu6k_hi5w0Rh8fyG0MZSdEQ5B-l0xJSuAx65PepP8T/exec?memberID=${encodeURIComponent(memberID)}&startDate=${startDate}&endDate=${endDate}`;
  
  try {
    const res = await fetch(url);
    const data = await res.json();

    if (data.error) {
      document.getElementById("result").innerHTML = `<p style="color:red;">${data.error}</p>`;
      return;
    }

    let html = `
      <div class="summary">
        <p><b>會員等級：</b>${data.memberLevel || '-'}　
        <b>折扣%：</b>${data.memberDiscount || '-'}　
        <b>到期日：</b>${data.memberExpire || '-'}</p>
        <p><b>目前餘額：</b>${data.currentBalance || 0}</p>
        <p><b>歷史儲值總額：</b>${data.totalDeposit || 0}　
        <b>紅利總額：</b>${data.totalBonus || 0}　
        <b>折扣總額：</b>${data.totalDiscountAmount || 0}</p>
      </div>
    `;

    if (!data.transactions || data.transactions.length === 0) {
      html += `<p>${data.note || "查無交易資料。"}</p>`;
    } else {
      html += `<table>
        <tr>
          <th>日期</th><th>訂單號</th><th>儲值金</th><th>紅利</th><th>扣款金額</th><th>折扣金額</th><th>調整</th><th>餘額</th>
        </tr>`;
      data.transactions.forEach(t => {
        html += `<tr>
          <td>${t.date}</td>
          <td>${t.orderID}</td>
          <td>${t.deposit}</td>
          <td>${t.bonus}</td>
          <td>${t.deduction}</td>
          <td>${t.discountAmount}</td>
          <td>${t.adjustment}</td>
          <td>${t.balance}</td>
        </tr>`;
      });
      html += `</table>`;
    }

    document.getElementById("result").innerHTML = html;

  } catch (err) {
    document.getElementById("result").innerHTML = `<p style="color:red;">查詢失敗：${err.message}</p>`;
  }
}
</script>
</body>
</html>
