<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>會員交易查詢系統</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
      background-color: #f8f9fa;
      color: #333;
    }
    h2 {
      text-align: center;
      color: #444;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    input, select, button {
      padding: 6px 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      background-color: #1976d2;
      color: #fff;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background-color: #125ea8;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background: white;
    }
    th, td {
      border: 1px solid #ddd;
      text-align: center;
      padding: 8px;
    }
    th {
      background-color: #1976d2;
      color: white;
    }
    .balance {
      text-align: center;
      font-size: 20px;
      margin-top: 10px;
      font-weight: bold;
      color: #1565c0;
    }
    .summary {
      text-align: center;
      font-size: 15px;
      margin-top: 4px;
    }
    .muted {
      color: #777;
      text-align: center;
      margin-top: 5px;
      font-size: 13px;
    }
    .error {
      color: red;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <h2>A會員儲值與交易查詢</h2>

  <label>會員號：</label>
  <input type="text" id="memberID" placeholder="輸入會員號，例如 A123456789" />

  <label>日期篩選：</label>
  <select id="dateRange">
    <option value="">全部日期</option>
    <option value="30">近 30 天</option>
    <option value="60">近 60 天</option>
    <option value="90">近 90 天</option>
    <option value="custom">自訂區間</option>
  </select>

  <div id="customDates" style="display:none; margin-top:10px;">
    <label>開始日期：</label>
    <input type="date" id="startDate" />
    <label>結束日期：</label>
    <input type="date" id="endDate" />
  </div>

  <button id="searchBtn" style="margin-top:15px;">查詢</button>

  <div id="result" style="margin-top:25px;"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwnbpsztBz_Fa-h8JoXvziYwPpdYaiySQM-uEmnmxPShSaga-S0BlnIFGSQrrx7ET-T/exec"; // ← 請換成你的 Google Apps Script 網址

    document.getElementById("dateRange").addEventListener("change", function () {
      const show = this.value === "custom";
      document.getElementById("customDates").style.display = show ? "block" : "none";
    });

    document.getElementById("searchBtn").addEventListener("click", search);

    async function search() {
      const memberID = document.getElementById("memberID").value.trim();
      const range = document.getElementById("dateRange").value;
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "<div style='text-align:center;color:#555;'>查詢中...</div>";

      if (!memberID) {
        resultDiv.innerHTML = `<div class="error">請輸入會員號</div>`;
        return;
      }

      let startDate = "", endDate = "";
      if (range === "custom") {
        startDate = document.getElementById("startDate").value;
        endDate = document.getElementById("endDate").value;
      } else if (range) {
        const days = parseInt(range);
        const now = new Date();
        endDate = now.toISOString().split("T")[0];
        const start = new Date(now);
        start.setDate(start.getDate() - days);
        startDate = start.toISOString().split("T")[0];
      }

      const url = `${API_URL}?memberID=${encodeURIComponent(memberID)}&startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`;
      
      try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) {
          resultDiv.innerHTML = `<div class="error">${escapeHtml(data.error)}</div>`;
          return;
        }

        const rows = data.transactions || [];
        const currentBalance = Number(data.currentBalance || 0).toFixed(2);
        const totalDeposit = Number(data.totalDeposit || 0).toFixed(2);
        const totalBonus = Number(data.totalBonus || 0).toFixed(2);
        const rangeDeposit = Number(data.rangeDeposit || 0).toFixed(2);
        const rangeBonus = Number(data.rangeBonus || 0).toFixed(2);
        const note = data.note || "";

        let html = `<div class="balance">目前餘額：$${escapeHtml(currentBalance)}</div>`;
        html += `<div class="summary">區間儲值：$${escapeHtml(rangeDeposit)}　｜　區間紅利：$${escapeHtml(rangeBonus)}</div>`;
        html += `<div class="summary" style="font-weight:600;">歷史總儲值：$${escapeHtml(totalDeposit)}　｜　歷史總紅利：$${escapeHtml(totalBonus)}</div>`;

        if (note) html += `<div class="muted">${escapeHtml(note)}</div>`;
        html += `<p style="text-align:center; margin-top:6px;">共 ${rows.length} 筆交易紀錄</p>`;

        if (rows.length === 0) {
          html += `<div style="text-align:center; margin-top:10px; color:#666;">無符合條件的交易紀錄。</div>`;
          resultDiv.innerHTML = html;
          return;
        }

        html += `<table>
          <tr>
            <th>日期</th>
            <th>訂單號</th>
            <th>儲值金</th>
            <th>紅利</th>
            <th>扣款</th>
            <th>特殊調整</th>
            <th>餘額</th>
          </tr>`;

        html += rows.map(r => `
          <tr>
            <td>${escapeHtml(r.date)}</td>
            <td>${escapeHtml(r.orderID)}</td>
            <td>${escapeHtml(Number(r.deposit).toFixed(2))}</td>
            <td>${escapeHtml(Number(r.bonus).toFixed(2))}</td>
            <td>${escapeHtml(String(r.deduction || ""))}</td>
            <td>${escapeHtml(String(r.adjustment || ""))}</td>
            <td>${escapeHtml(Number(r.balance).toFixed(2))}</td>
          </tr>
        `).join('');

        html += `</table>`;
        resultDiv.innerHTML = html;

      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `<div class="error">查詢時發生錯誤，請稍後再試。</div>`;
      }
    }

    function escapeHtml(str) {
      return String(str)
        .
