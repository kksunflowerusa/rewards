<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>會員交易查詢系統</title>
  <style>
    body {
      font-family: "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 16px;
    }

    .container {
      max-width: 860px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      color: #333;
      font-size: 22px;
    }

    label {
      display: block;
      margin-top: 10px;
      color: #444;
      font-weight: 600;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
    }

    button {
      background-color: #ffb703;
      color: #333;
      font-weight: bold;
      cursor: pointer;
      border: none;
      transition: background 0.2s;
    }

    button:hover {
      background-color: #ffa600;
    }

    .quick-select {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .quick-select button {
      flex: 1;
      padding: 8px;
      background-color: #e0e0e0;
      color: #333;
      font-size: 14px;
    }

    .quick-select button.active {
      background-color: #ffd166;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #f1f1f1;
    }

    .summary {
      background: #fff8e1;
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
    }

    .summary div {
      margin-bottom: 6px;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 18px;
      }
      table {
        font-size: 12px;
      }
      button, input {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>KK Sunflower會員儲值金與會員積點交易查詢</h1>

    <label for="memberID">會員帳號：</label>
    <input type="text" id="memberID" placeholder="請輸入會員帳號(如A12345)" />

    <label>查詢期間：</label>
    <div class="quick-select">
      <button id="btn30">近30天</button>
      <button id="btn60">近60天</button>
    </div>

    <label for="startDate">開始日期：</label>
    <input type="date" id="startDate" />

    <label for="endDate">結束日期：</label>
    <input type="date" id="endDate" />

    <button id="searchBtn">查詢交易紀錄</button>

    <div class="summary" id="memberInfo" style="display:none;">
      <div><strong>會員等級：</strong><span id="membershipLevel">—</span></div>
      <div><strong>會員折扣：</strong><span id="membershipDiscount">—</span></div>
      <div><strong>會員到期日：</strong><span id="membershipExpiry">—</span></div>
      <hr>
      <div><strong>KK儲值金餘額：</strong><span id="currentBalance">—</span></div>
      <div><strong>會員積點餘額：</strong><span id="currentPointsBalance">—</span></div>
      <div><strong>累計儲值金：</strong><span id="totalStored">—</span></div>
      <div><strong>累計紅利：</strong><span id="totalBonus">—</span></div>
      <div><strong>累計折抵：</strong><span id="totalDiscount">—</span></div>
    </div>

    <table id="resultTable" style="display:none;">
      <thead>
        <tr>
          <th>日期</th>
          <th>交易內容</th>
          <th>金額</th>
          <th>儲值金變動</th>
          <th>紅利點數變動</th>
          <th>折抵金額</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxXXXXXXXXXXXXXXX/exec"; // 改成你的 Apps Script 部署網址

    // 快捷查詢
    const btn30 = document.getElementById("btn30");
    const btn60 = document.getElementById("btn60");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");

    btn30.addEventListener("click", () => setQuickRange(30, btn30));
    btn60.addEventListener("click", () => setQuickRange(60, btn60));

    function setQuickRange(days, activeBtn) {
      const today = new Date();
      const past = new Date();
      past.setDate(today.getDate() - days);

      endDateInput.value = today.toISOString().split("T")[0];
      startDateInput.value = past.toISOString().split("T")[0];

      [btn30, btn60].forEach(b => b.classList.remove("active"));
      activeBtn.classList.add("active");
    }

    // 查詢按鈕
    document.getElementById("searchBtn").addEventListener("click", async () => {
      const memberID = document.getElementById("memberID").value.trim();
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;

      if (!memberID) {
        alert("請輸入會員帳號！");
        return;
      }

      const url = `${scriptURL}?memberID=${encodeURIComponent(memberID)}&startDate=${startDate}&endDate=${endDate}`;

      const res = await fetch(url);
      const data = await res.json();

      if (!data || !data.records || data.records.length === 0) {
        alert("查無交易紀錄！");
        document.getElementById("resultTable").style.display = "none";
        document.getElementById("memberInfo").style.display = "none";
        return;
      }

      // 顯示會員資料
      const memberData = data.memberData;
      document.getElementById("membershipLevel").textContent = memberData.membershipLevel || "—";
      document.getElementById("membershipDiscount").textContent = 
        memberData.membershipDiscount ? memberData.membershipDiscount + "%" : "—";
      document.getElementById("membershipExpiry").textContent = memberData.membershipExpiry || "—";
      document.getElementById("currentBalance").textContent = memberData.currentBalance || "—";
      document.getElementById("currentPointsBalance").textContent = memberData.currentPointsBalance || "—";
      document.getElementById("totalStored").textContent = memberData.totalStored || "—";
      document.getElementById("totalBonus").textContent = memberData.totalBonus || "—";
      document.getElementById("totalDiscount").textContent = memberData.totalDiscount || "—";
      document.getElementById("memberInfo").style.display = "block";

      // 顯示交易紀錄表格
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";
      data.records.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.content}</td>
          <td>${r.amount}</td>
          <td>${r.balanceChange}</td>
          <td>${r.pointsChange}</td>
          <td>${r.discount}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById("resultTable").style.display = "table";
    });
  </script>
</body>
</html>
