function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle('會員交易紀錄查詢')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function searchTransactions(memberId, startDate, endDate, quickRange) {
  try {
    const sheet = SpreadsheetApp.openById("1hMdR4oz8lG7otmOHYALLW3_42O0-jSzMseoR1l6oD8Y")
      .getSheetByName("Transactions"); // ✅ 修改為實際表單名稱

    const data = sheet.getRange(5, 2, sheet.getLastRow() - 4, 10).getDisplayValues(); 
    const today = new Date();
    let start, end;

    // 日期處理
    if (quickRange === "30") {
      start = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
      end = today;
    } else if (quickRange === "60") {
      start = new Date(today.getTime() - 60 * 24 * 60 * 60 * 1000);
      end = today;
    } else {
      start = startDate ? new Date(startDate) : new Date("2000-01-01");
      end = endDate ? new Date(endDate) : today;
    }

    const results = data.filter(row => {
      const dateStr = row[0];
      if (!dateStr) return false;
      const date = new Date(dateStr);
      const member = String(row[1]).trim();
      return member === memberId && date >= start && date <= end;
    }).map(row => ({
      date: row[0],
      member: row[1],
      order: row[2],
      deposit: row[3],
      bonus: row[4],
      deduction: row[5],
      adjust: row[6],
      balance: row[7]
    }));

    return results.length > 0 ? results : [{error: "查無符合條件的交易紀錄"}];
  } catch (err) {
    return [{error: "查詢失敗：" + err.message}];
  }
}

function exportTransactions(memberId, startDate, endDate, quickRange) {
  const results = searchTransactions(memberId, startDate, endDate, quickRange);
  if (results.length === 0 || results[0].error) {
    throw new Error("無符合條件的資料，無法匯出");
  }

  const headers = ["日期", "會員號", "訂單號", "儲值金", "額外紅利", "扣款金額", "特殊調整", "餘額"];
  const sheetData = [headers, ...results.map(r => [
    r.date, r.member, r.order, r.deposit, r.bonus, r.deduction, r.adjust, r.balance
  ])];

  // 建立 Excel 檔案
  const file = SpreadsheetApp.create("tempExport");
  const tempSheet = file.getActiveSheet();
  tempSheet.clear();
  tempSheet.getRange(1, 1, sheetData.length, sheetData[0].length).setValues(sheetData);

  // 匯出成 Excel 檔案
  const xlsx = DriveApp.getFileById(file.getId()).getAs("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

  // ✅ 自動帶會員號與日期
  const today = Utilities.formatDate(new Date(), "Asia/Taipei", "yyyy-MM-dd");
  const filename = `交易紀錄_${memberId}_${today}.xlsx`;

  // 刪除暫存檔
  DriveApp.getFileById(file.getId()).setTrashed(true);

  return {
    blob: Utilities.base64Encode(xlsx.getBytes()),
    filename: filename,
    mimeType: xlsx.getContentType()
  };
}
