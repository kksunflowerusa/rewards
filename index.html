<!DOCTYPE html> 
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KK會員儲值與交易查詢</title>
  <style>
    :root {
      --primary: #007bff;
      --primary-dark: #005fcc;
      --bg: #f8fafc;
    }
    body {
      font-family: "Noto Sans TC", Arial, sans-serif;
      max-width: 860px;
      margin: 0 auto;
      padding: 0 12px 80px;
      background: var(--bg);
    }
    h2 {
      text-align: center;
      color: #222;
      margin: 20px 0 10px;
      font-size: 1.5rem;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
      font-size: 0.95rem;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      box-sizing: border-box;
      margin-top: 4px;
    }
    button {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-width: 860px;
      margin: 0 auto;
      z-index: 999;
    }
    button:hover { background: var(--primary-dark); }
    .result { margin-top: 20px; }
    .error { color: #d32f2f; text-align: center; font-weight: bold; }
    .balance {
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      color: var(--primary);
      margin-top: 10px;
    }
    .summary {
      text-align: center;
      font-size: 14px;
      color: #333;
      margin-top: 6px;
      line-height: 1.5;
    }
    .muted { text-align: center; color: #666; font-size: 13px; margin-top: 6px; }
    .table-container {
      overflow-x: auto;
      margin-top: 15px;
      background: white;
      border-radius: 6px;
    }
    table { width: 100%; min-width: 960px; border-collapse: collapse; }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 13px;
      white-space: nowrap;
    }
    th { background: #f1f3f5; }
    @media (max-width: 720px) {
      th, td { font-size: 12px; padding: 6px; }
      h2 { font-size: 1.3rem; }
      .balance { font-size: 18px; }
      .summary { font-size: 13px; }
    }
  </style>
</head>
<body>
  <h2>KK會員儲值與交易查詢</h2>

  <label>會員號 (例如：A12345)</label>
  <input id="memberID" placeholder="請輸入會員號">

  <label>開始日期</label>
  <input id="startDate" type="date">

  <label>結束日期</label>
  <input id="endDate" type="date">

  <label>快捷查詢</label>
  <select id="quickRange" onchange="applyQuickRange()">
    <option value="">--請選擇--</option>
    <option value="30">近30天</option>
    <option value="60">近60天</option>
  </select>

  <button onclick="search()">查詢</button>

  <div id="result" class="result"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxqUaEb1YTNpun-pcjiaaWfH_QXVXX4G9R7HxwOuXnKm9sq_M2HCCQtTHQJ5pBaRxY/exec";

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, s => (
        { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[s]
      ));
    }

    function applyQuickRange() {
      const range = document.getElementById("quickRange").value;
      if (!range) {
        document.getElementById("startDate").value = "";
        document.getElementById("endDate").value = "";
        return;
      }
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - Number(range));
      document.getElementById("startDate").value = start.toISOString().slice(0,10);
      document.getElementById("endDate").value = end.toISOString().slice(0,10);
    }

    async function search() {
      const memberID = document.getElementById('memberID').value.trim();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = `<p class="muted">查詢中...</p>`;

      if (!memberID) {
        resultDiv.innerHTML = `<p class="error">請輸入會員號。</p>`;
        return;
      }

      try {
        const url = `${API_URL}?memberID=${encodeURIComponent(memberID)}&startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`;
        const resp = await fetch(url);
        const data = await resp.json();

        if (data.error) {
          resultDiv.innerHTML = `<p class="error">${escapeHtml(data.error)}</p>`;
          return;
        }

        const rows = data.transactions || [];
        const currentBalance = data.currentBalance || "0";
        const currentPointsBalance = data.currentPointsBalance || "0";
        const totalDeposit = data.totalDeposit || "0";
        const totalBonus = data.totalBonus || "0";
        const totalDiscountAmount = data.totalDiscountAmount || "0";
        const memberLevel = data.memberLevel || "-";
        const memberDiscount = data.memberDiscount || "-";
        const memberExpire = data.memberExpire || "-";
        const note = data.note || "";

        let html = `<div class="balance">目前餘額：$${escapeHtml(currentBalance)}　｜　積點餘額：${escapeHtml(currentPointsBalance)} 點</div>`;
        html += `<div class="summary">等級：${escapeHtml(memberLevel)}　｜　折扣：${escapeHtml(memberDiscount)}%　｜　到期：${escapeHtml(memberExpire)}</div>`;
        html += `<div class="summary">儲值總額：$${escapeHtml(totalDeposit)}　｜　紅利總額：$${escapeHtml(totalBonus)}　｜　折扣總額：$${escapeHtml(totalDiscountAmount)}</div>`;

        if (note) html += `<div class="muted">${escapeHtml(note)}</div>`;

        html += `<p style="text-align:center; margin-top:8px;">共 ${rows.length} 筆交易紀錄</p>`;

        if (rows.length === 0) {
          html += `<div style="text-align:center; margin-top:10px; color:#666;">無符合篩選的交易紀錄。</div>`;
          resultDiv.innerHTML = html;
          return;
        }

        html += `<div class="table-container"><table><tr>
          <th>日期</th>
          <th>訂單號</th>
          <th>儲值金</th>
          <th>紅利</th>
          <th>扣款金額</th>
          <th>折扣金額</th>
          <th>特殊調整</th>
          <th>餘額</th>
          <th>積點(+)</th>
          <th>積點(-)</th>
          <th>積點餘額</th>
        </tr>`;

        html += rows.map(r => `
          <tr>
            <td>${escapeHtml(r.date)}</td>
            <td>${escapeHtml(r.orderID)}</td>
            <td>${escapeHtml(r.deposit)}</td>
            <td>${escapeHtml(r.bonus)}</td>
            <td>${escapeHtml(r.deduction)}</td>
            <td>${escapeHtml(r.discountAmount)}</td>
            <td>${escapeHtml(r.adjustment)}</td>
            <td>${escapeHtml(r.balance)}</td>
            <td>${escapeHtml(r.pointsAdd)}</td>
            <td>${escapeHtml(r.pointsDeduct)}</td>
            <td>${escapeHtml(r.pointsBalance)}</td>
          </tr>
        `).join('');

        html += `</table></div>`;
        resultDiv.innerHTML = html;

      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `<p class="error">查詢失敗：${escapeHtml(err.message)}</p>`;
      }
    }
  </script>
</body>
</html>
